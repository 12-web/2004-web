import{r as d,j as s,b as pe,a as L,e as Be,f as Ue,m as G,n as We,c as V,u as ue,o as Ce,p as He,q as Je,l as ge,t as Re,v as Ve}from"./index-CnjHjZ9w.js";import{T as K,L as I}from"./Layout-_-Xp0wVg.js";import{R as Qe,I as Ze,D as Z,C as Ke,T as Le,H as v,S as _e,g as Xe,a as ye,b as Ye,A as es}from"./Alert-Cnu6Ys1Q.js";import{B as ss,C as ts,D as rs,m as M,u as as,I as Te,c as ns,i as Ee,G as H,b as te,M as je,s as g,a as ee,R as z,d as ls,e as is,f as os,U as ds,t as cs,g as us,h as ms}from"./toBase64-PEfcJN1Z.js";import{f as J,r as fe,B as hs,d as re,a as w,g as Oe,F as Se,m as O,b as k,u as qe,w as ps,T as bs,D as se,I as ce,e as Ie}from"./useToast-bJRhAPp4.js";import{B as _}from"./MixSpace-D6Pb7ywy.js";import{T as Ds}from"./TextField-BsGPomXW.js";import{I as Fe,L as xs}from"./LayoutContainer-bIW1f0r6.js";import"./createResponsesImage-DXUTwyiR.js";const Cs=({status:e})=>{const t=d.useMemo(()=>{switch(!0){case e==="Редактируется":return"#FADB14";case e==="Введен":return"#FA8C16";case e==="В пачке":return"#F5222D";case e==="Просчитан":return"#EB2F96";case e==="Перемещается в пикинг/OA":return"#4532FF";case e==="В подборке":return"#1ABAFF";case e==="Подобран":return"#13C2C2";case e==="Ушел со склада":return"#52C41A";default:return"#D1D2DE"}},[e]);return s.jsxs(s.Fragment,{children:[e!=="-"&&s.jsx(ss,{style:{boxShadow:`inset 0 0 0 var(--badge-size) ${t}`,flexShrink:0},minified:!0,size:"s"}),s.jsx(K,{size:"s",lineHeight:"s",children:e})]})},gs=({orders:e,...t})=>{const{accessor:r,openedFilter:l}=t,x=d.useMemo(()=>e.map(m=>{let h;return r&&(r==="loadStartDate"||r==="creationDate"?h=J(m[r]):h=m[r]),{name:h||"(Пусто)",value:r?m[r].toString():""}}),[]);return s.jsx(Qe,{isOpen:l===r,checkboxes:x,...t})},we=e=>({orderId:e.OrderId,no:e.No,client:{label:e.Client.Name,id:e.Client.ClientId,code:e.Client.Code},clientId:e.Client.ClientId,clientLabel:e.Client.Name,clientCode:e.Client.Code,shipmentAddress:{label:e.ShipmentAddress.Name,id:e.ShipmentAddress.ClientId,code:e.ShipmentAddress.Code},warehouse:{label:e.Warehouse.Name,id:e.Warehouse.WarehouseId,code:e.Warehouse.Code,shippingWarehouse:0},driver:e.Driver,amNumber:e.CarNo,sealNumber:e.SealNo,loadEndDate:e.LoadingDateTimeEnd,loadStartDate:e.LoadingDateTimeStart,departureDate:e.DepartureActualDateTime,creationDate:fe(e.DateCreation),shipmentDate:fe(e.DateShipment),editable:e.Editable,status:e==null?void 0:e.Status,removal:e.Status==="Редактируется"||e.Status==="Введен"}),X=pe.injectEndpoints({endpoints:e=>({getOrderById:e.query({query:t=>({url:"",method:"GET",params:{command:L.GET_ORDER,json:JSON.stringify(t),emelClass:"API3PL"}}),transformResponse:({Order:t,Error:r})=>({Order:t?we(t):void 0,Error:r}),providesTags:["ORDER"]}),getOrders:e.query({query:t=>({url:"",method:"GET",params:{command:L.GET_ORDERS,json:JSON.stringify(t),emelClass:"API3PL"}}),transformResponse:({Order:t,Error:r})=>({Order:t==null?void 0:t.map(we),Error:r}),providesTags:["ORDER"]}),postOrder:e.mutation({query:t=>({url:"",method:"GET",params:{command:L.POST_ORDER,json:JSON.stringify(t),emelClass:"API3PL"}}),invalidatesTags:["ORDER"]}),putOrder:e.mutation({query:t=>({url:"",method:"POST",params:{command:L.PUT_ORDER,json:JSON.stringify(t),emelClass:"API3PL"}}),invalidatesTags:["ORDER"]}),deleteOrder:e.mutation({query:t=>({url:"",method:"POST",params:{command:L.DELETE_ORDER,json:JSON.stringify(t),emelClass:"API3PL"}}),invalidatesTags:["ORDER"]}),runOrder:e.mutation({query:t=>({url:"",method:"POST",params:{command:L.RUN_ORDER,json:JSON.stringify(t),emelClass:"API3PL"}}),invalidatesTags:["ORDER"]}),uploadOrder:e.mutation({query:t=>({url:"",method:"POST",params:{command:L.UPLOAD_ORDER,emelClass:"API3PL"},body:{TockenId:Be.getState().authUser.token,FileEncode:"utf8",...t}}),invalidatesTags:["ORDER"]})})}),js=()=>{const e=Ue(),t=r=>e(We({columns:r}));return s.jsx(ts,{onSetTableCols:t,cols:Object.values(G).filter(r=>r.title)})},Os="_toolbar_9uf6u_1",Ss="_buttons_group_9uf6u_8",ys="_buttons_9uf6u_8",ae={toolbar:Os,buttons_group:Ss,buttons:ys},fs=({onResetFilters:e,startDate:t,endDate:r,search:l,setSearch:x,...m})=>{const h=V(),C=j=>h(Ce(j)),i=ue(j=>j.asnTableState),c=j=>{console.log(i)},b=[{label:"EXCEL",handleClick:c},{label:"PDF",handleClick:c}];return s.jsxs(I,{className:ae.toolbar,direction:"column",children:[s.jsxs(I,{className:ae.filter_group,children:[s.jsx(rs,{startDate:t,endDate:r,...m}),s.jsx(I,{children:s.jsx(Ds,{className:ae.search,placeholder:"Найти заказ по номеру",rightSide:Ze,value:l,type:"text",size:"s",onChange:x})})]}),s.jsxs(I,{className:ae.buttons_group,children:[s.jsx(I,{className:ae.buttons,children:s.jsx(_,{className:"button",label:"Новый заказ",size:"s",view:"secondary",iconLeft:Fe,onClick:()=>C(M.ADD_ORDER_MODAL_ID)})}),s.jsxs(I,{className:ae.buttons,children:[s.jsx(_,{onClick:e,className:"button",label:"Очистить все фильтры",size:"s",view:"secondary"}),s.jsx(js,{}),s.jsx(_,{className:"button",label:"Импорт из файла",size:"s",view:"secondary",onClick:()=>C(M.IMPORT_ORDERS)}),s.jsx(hs,{buttonName:"Экспорт таблицы",btns:b})]})]})]})},Is="_table_1atsu_1",ws="_cell_1atsu_19",As="_cellButton_1atsu_24",Ns="_switchButton_1atsu_31",Rs="_noData_1atsu_35",Ls="_activeHeaderCell_1atsu_42",_s="_pagination_1atsu_46",W={table:Is,cell:ws,cellButton:As,switchButton:Ns,noData:Rs,activeHeaderCell:Ls,pagination:_s},Ts=({onEditOrder:e})=>{const t=as(),[r,l]=d.useState(null),x=V();re();const{data:m,isLoading:h}=X.useGetOrdersQuery({DateTo:w(t.endDate)||"",DateFrom:w(t.startDate)||""}),C=d.useMemo(()=>{var o;return((o=m==null?void 0:m.Order)==null?void 0:o.filter(f=>f.no.toLowerCase().startsWith((r==null?void 0:r.toLowerCase())||"")))||[]},[r,m]),{columns:i}=ue(o=>o.orderTableState),c=o=>{x(Je({order:o})),x(Ce(M.DELETE_ORDER_MODAL_ID))},b=d.useCallback(({row:o})=>s.jsx(Z,{style:{cursor:"pointer"},className:W.cell,onClick:()=>e(o),children:s.jsx(K,{size:"s",view:"brand",children:o.no?o.no:"-"})}),[]),j=d.useCallback(({row:o})=>s.jsx(Z,{className:W.cell,children:s.jsx(K,{size:"s",children:J(o.creationDate)})}),[]),y=d.useCallback(({row:o})=>s.jsx(Z,{className:W.cell,children:s.jsx(Cs,{status:o.status?o.status:"-"})}),[]),u=d.useCallback(({row:o})=>s.jsx(Z,{className:W.cell,children:s.jsx(K,{size:"s",children:o.clientCode?o.clientCode:"-"})}),[]),S=d.useCallback(({row:o})=>s.jsx(Z,{className:W.cell,children:s.jsx(K,{size:"s",children:o.amNumber?o.amNumber:"-"})}),[]),A=d.useCallback(({row:o})=>s.jsx(Z,{className:W.cell,children:s.jsx(K,{size:"s",children:o.clientLabel?o.clientLabel:"-"})}),[]),$=d.useCallback(({row:o})=>s.jsx(Z,{className:W.cell,children:s.jsx(K,{size:"s",children:o.driver?o.driver:"-"})}),[]),T=d.useCallback(({row:o})=>s.jsx(Z,{className:W.cellButton,children:s.jsx(_,{size:"s",view:"clear",iconRight:Te,onlyIcon:!0,onClick:()=>c(o),disabled:!o.removal,title:"Удалить"})}),[]),Q=d.useMemo(()=>[{...G.no,width:"1fr",minWidth:180,renderCell:b},{...G.creationDate,width:"1fr",minWidth:180,renderCell:j},{...G.status,width:"1fr",minWidth:180,renderCell:y},{...G.clientCode,width:"1fr",minWidth:180,renderCell:u},{...G.clientLabel,width:"1fr",minWidth:180,renderCell:A},{...G.amNumber,width:"1fr",minWidth:180,renderCell:S},{...G.driver,width:"1fr",minWidth:180,renderCell:$},{...G.removal,maxWidth:40,renderCell:T,renderHeaderCell:v}].filter(({accessor:f})=>(i==null?void 0:i.some(B=>B.accessor===f))||G[f||""].isRequired),[i]),E=d.useCallback(o=>{x(He(o))},[]);return s.jsx(Ke,{onSetRows:E,data:C,isLoading:h,paginationClass:W.pagination,children:({paginatedData:o,sortColumn:f,handleSort:B,...p})=>s.jsxs(s.Fragment,{children:[s.jsx(fs,{...t,setSearch:l,search:r,onResetFilters:p.resetFilters}),s.jsx(I,{direction:"column",children:s.jsx(Le,{className:W.table,stickyHeader:!0,rows:o,headerZIndex:1,getRowKey:N=>N.orderId,columns:Q.map(N=>({...N,renderHeaderCell:({tableRef:le,...q})=>s.jsx(v,{isActive:N.accessor===f,controlRight:N.title?[s.jsx(gs,{accessor:N.accessor||Object.values(G)[0].accessor,orders:C,...p})]:null,icon:N.title?s.jsx(_e,{isActive:N.accessor===f}):void 0,onClick:()=>B(N.accessor||"orderId"),...q})}))})})]})})},ve=pe.injectEndpoints({endpoints:e=>({getShipAddresses:e.query({query:t=>({url:"",params:{command:L.GET_SHIPMENT_ADDRESS,emelClass:"API3PL",json:JSON.stringify(t)}}),transformResponse:({Client:t,Error:r})=>({ShipAddresses:t==null?void 0:t.map(ns),Error:r}),providesTags:["ADDRESSES"]}),postShipmentAddress:e.mutation({query:t=>({url:"",method:"POST",params:{command:L.POST_SHIPMENT_ADDRESS,emelClass:"API3PL",json:JSON.stringify(t)}}),invalidatesTags:["ADDRESSES"]})})}),Es=e=>({newName:e.label,newCode:e.code,newAddr:e.address,orgId:e.client.id}),qs="_btn_s2uyy_1",Fs="_header_s2uyy_11",Ae={btn:qs,header:Fs},vs=()=>{const e=Oe(),{register:t,handleSubmit:r,reset:l}=e,[x,{data:m,isSuccess:h,isLoading:C}]=ve.usePostShipmentAddressMutation(),{showToast:i}=re(),c=V(),b=()=>c(ge()),j=async u=>{try{const{result:S,Error:A}=await x(Es(u)).unwrap();S&&(i("Новый адрес клиента успешно добавлен","success"),b(),l()),A&&i(A)}catch{}},{data:y}=Ee.useGetClientsQuery();return s.jsx(Se,{...e,children:s.jsxs("form",{onSubmit:r(j),className:Ae.root,children:[s.jsxs(H,{rowGap:"s",children:[s.jsx(te,{items:(y==null?void 0:y.Clients)||[],registered:t("client",{required:O.required}),required:!0,label:"Клиент",onChange:()=>{},size:"s",placeholder:"Клиент"}),s.jsx(k,{registered:t("code",{required:O.required,setValueAs:u=>u.trim()}),required:!0,type:"text",placeholder:"Код нового адреса",label:"Код нового адреса",size:"s"}),s.jsx(k,{registered:t("label",{required:O.required,setValueAs:u=>u.trim()}),required:!0,type:"text",placeholder:"Наименование адреса доставки",label:"Наименование",size:"s"}),s.jsx(k,{registered:t("address",{required:O.required,setValueAs:u=>u.trim()}),required:!0,type:"text",placeholder:"Адрес доставки",label:"Адрес",size:"s"})]}),s.jsx(_,{className:Ae.btn,label:"Сохранить",type:"submit",size:"s",loading:C})]})})},zs="_clientModal_19a81_1",Ps={clientModal:zs},ks=({})=>s.jsx(je,{modalId:M.ADD_NEW_CLIENT_ADDRESS,title:"Добавить новый адрес клиента",className:Ps.clientModal,children:s.jsx(vs,{})}),$s=e=>({id:e.OrderLineId,bbd:e.BBD,prd:e.PRD,count:e.Count,measurementUnit:{id:e.MU.MuId,label:e.MU.Name,extId:e.MU.ExtMuId,extLabel:e.MU.ExtName},lot:{id:e.Lot.LotId,label:e.Lot.LotNo,bbd:new Date().toString(),lifetime:0},good:{id:e.GoodItem.GoodItemId,article:e.GoodItem.Code,label:e.GoodItem.Name,brutto:0,height:0,length:0,netto:0,width:0},goodArticle:e.GoodItem.Code,goodLabel:e.GoodItem.Name,lotNo:e.Lot.LotNo,MU:e.MU.Name}),ne=pe.injectEndpoints({endpoints:e=>({getOrderLines:e.query({query:t=>({url:"",method:"POST",params:{command:L.GET_ORDER_LINES,json:JSON.stringify(t),emelClass:"API3PL"}}),transformResponse:({OrderLine:t,Error:r})=>({OrderLine:t==null?void 0:t.map($s),Error:r}),providesTags:["ORDER_LINE"]}),postOrderLine:e.mutation({query:t=>({url:"",method:"POST",params:{command:L.POST_ORDER_LINE,json:JSON.stringify(t),emelClass:"API3PL"}}),invalidatesTags:["ORDER_LINE"]}),putOrderLine:e.mutation({query:t=>({url:"",method:"POST",params:{command:L.PUT_ORDER_LINE,json:JSON.stringify(t),emelClass:"API3PL"}}),invalidatesTags:["ORDER_LINE"]}),deleteOrderLine:e.mutation({query:t=>({url:"",method:"POST",params:{command:L.DELETE_ORDER_LINE,json:JSON.stringify(t),emelClass:"API3PL"}}),invalidatesTags:["ORDER_LINE"]})})}),ze={INTRODUCED:50,EDITED:25},Gs=e=>({Order:{No:e.orderNumber,LoadingDateTimeStart:w(new Date(e.loadStartDate))||"",LoadingDateTimeEnd:w(new Date(e.loadEndDate))||"",DepartureActualDateTime:w(new Date(e.departureDate))||"",DateShipment:w(new Date(e.shipmentDate))||"",DateCreation:w(new Date(e.creationDate))||"",ClientId:e.client.id,ShipmentAddressId:e.shipmentAddress.id,WarehouseId:e.warehouse.id,VendorId:e.client.id,SealNo:e.sealNumber,Driver:e.driver,ShipmentId:-1,CarNo:e.amNumber,TN_No:"",FindingTS:""}}),Ms=(e,t)=>({Order:{OrderId:t,No:e.orderNumber,ClientId:e.client.id,ShipmentAddressId:e.shipmentAddress.id,WarehouseId:e.warehouse.id,VendorId:0,LoadingDateTimeStart:w(new Date(e.loadStartDate))||"",LoadingDateTimeEnd:w(new Date(e.loadEndDate))||"",DepartureActualDateTime:w(new Date(e.departureDate))||"",DateShipment:w(new Date(e.shipmentDate))||"",DateCreation:w(new Date(e.creationDate))||"",FindingTS:"",ShipmentId:-1,CarNo:e.amNumber,SealNo:e.sealNumber,TN_No:"",Driver:e.driver}}),Pe=(e,t)=>({OrderLine:{OrderId:t,GoodItemId:e.good.id,LotId:e.lot.id,MuId:e.measurementUnit.id,BBD:w(e.bbd)||"",Count:parseInt(e.count)}}),Bs=(e,t)=>{var r;return{OrderLine:{OrderLineId:t,GoodItemId:e.good.id,LotId:(r=e.lot)==null?void 0:r.id,MuId:e.measurementUnit.id,BBD:w(e.bbd)||"",Count:parseInt(e.count)}}},ke=({isEditMode:e,isLoading:t})=>{const{register:r,setValue:l,resetField:x,watch:m}=qe();re();const{data:h}=ps.useGetWarehousesQuery(),{data:C}=Ee.useGetClientsQuery(),[i,{data:c}]=ve.useLazyGetShipAddressesQuery();return V(),d.useEffect(()=>{if(!e)return;const b=m("client");b!=null&&b.id&&i({ClientId:b==null?void 0:b.id})},[e]),s.jsx(bs,{children:({step:b,steps:j})=>{var y;return s.jsxs(s.Fragment,{children:[s.jsxs(H,{cols:2,colGap:"s",className:b===j[0]?void 0:g.hidden,children:[s.jsx(ee,{children:s.jsxs(H,{rowGap:"s",children:[s.jsx(k,{registered:r("orderNumber",{required:O.required,setValueAs:u=>u.trim()}),readOnly:!e,required:e,type:"text",label:"Номер заказа",size:"s",disabled:t,placeholder:"Введите номер заказа"}),s.jsxs(H,{cols:2,yAlign:"top",gap:"s",children:[s.jsx(z,{isReplacing:!e,label:"Клиент",path:"client.label",children:s.jsx(te,{items:(C==null?void 0:C.Clients)||[],registered:r("client",{required:O.required}),required:e,label:"Клиент",onChange:u=>{l("clientCode",(u==null?void 0:u.code)||""),u!=null&&u.id&&i({ClientId:u==null?void 0:u.id}),x("shipmentAddress"),x("shipmentAddressCode")},size:"s",disabled:t,placeholder:"Выберите"})}),s.jsx(k,{registered:r("clientCode"),readOnly:!0,type:"text",label:"Клиент",size:"s",placeholder:"Клиент"})]}),s.jsxs(H,{cols:2,yAlign:"top",gap:"s",children:[s.jsx(z,{isReplacing:!e,label:"Адрес доставки",path:"shipmentAddress.label",children:s.jsx(te,{items:(c==null?void 0:c.ShipAddresses)||[],registered:r("shipmentAddress",{required:O.required}),required:e,label:"Адрес доставки",onChange:u=>l("shipmentAddressCode",(u==null?void 0:u.code)||""),size:"s",disabled:!((y=c==null?void 0:c.ShipAddresses)!=null&&y.length)||t,placeholder:"Выберите"})}),s.jsx(k,{registered:r("shipmentAddressCode"),readOnly:!0,type:"text",placeholder:"Адрес",label:"Код",size:"s"})]}),s.jsxs(H,{cols:2,yAlign:"top",gap:"s",children:[s.jsx(z,{isReplacing:!e,label:"Склад отгрузки",path:"warehouse.label",children:s.jsx(te,{items:(h==null?void 0:h.Warehouse)||[],registered:r("warehouse",{required:O.required}),required:e,label:"Склад отгрузки",onChange:u=>l("warehouseCode",(u==null?void 0:u.code)||""),size:"s",disabled:t,placeholder:"Выберите"})}),s.jsx(k,{registered:r("warehouseCode"),readOnly:!0,type:"text",placeholder:"Склад отгрузки",label:"Код",size:"s"})]})]})}),s.jsx(ee,{children:s.jsxs(H,{rowGap:"s",children:[s.jsx(ee,{children:s.jsx(k,{registered:r("driver",{required:O.required,setValueAs:u=>u.trim()}),readOnly:!e,required:e,type:"text",label:"Водитель",size:"s",disabled:t,placeholder:"Водитель"})}),s.jsx(ee,{children:s.jsx(k,{registered:r("amNumber"),readOnly:!e,type:"text",label:"Номер а/м",size:"s",disabled:t,placeholder:"Номер а/м"})}),s.jsx(ee,{children:s.jsx(k,{registered:r("sealNumber",{required:O.required}),readOnly:!e,required:e,type:"text",label:"Номер пломбы",size:"s",disabled:t,placeholder:"Номер пломбы"})})]})})]}),s.jsxs(H,{cols:2,colGap:"s",className:b===j[1]?void 0:g.hidden,children:[s.jsx(ee,{children:s.jsxs(H,{rowGap:"s",children:[s.jsx(z,{isReplacing:!e,path:"creationDate",label:"Создан",valueModifier:J,children:s.jsx(se,{registered:r("creationDate",{required:O.required,valueAsDate:!0}),rightSide:ce,size:"s",label:"Создан",disabled:!0,format:"dd/MM/yyyy",placeholder:"дд/мм/гггг"})}),s.jsx(z,{isReplacing:!e,path:"loadStartDate",label:"Начало загрузки",valueModifier:J,children:s.jsx(se,{registered:r("loadStartDate",{required:O.required,valueAsDate:!0}),rightSide:ce,size:"s",label:"Начало загрузки",required:e,disabled:t,format:"dd/MM/yyyy",placeholder:"дд/мм/гггг"})}),s.jsx(z,{isReplacing:!e,path:"departureDate",label:"Убытие машины",valueModifier:J,children:s.jsx(se,{registered:r("departureDate",{required:O.required,valueAsDate:!0}),rightSide:ce,size:"s",label:"Убытие машины",required:e,disabled:t,format:"dd/MM/yyyy",placeholder:"дд/мм/гггг"})})]})}),s.jsx(ee,{children:s.jsxs(H,{rowGap:"s",children:[s.jsx(z,{isReplacing:!e,path:"shipmentDate",label:"Дата отгрузки",valueModifier:J,children:s.jsx(se,{registered:r("shipmentDate",{required:O.required,valueAsDate:!0}),rightSide:ce,size:"s",label:"Дата отгрузки",required:e,disabled:t,format:"dd/MM/yyyy",placeholder:"дд/мм/гггг"})}),s.jsx(z,{isReplacing:!e,path:"loadEndDate",label:"Окончание загрузки",valueModifier:J,children:s.jsx(se,{registered:r("loadEndDate",{required:O.required,valueAsDate:!0}),rightSide:ce,size:"s",label:"Окончание загрузки",required:e,disabled:t,format:"dd/MM/yyyy",placeholder:"дд/мм/гггг"})})]})})]})]})}})},Us=e=>({id:e.LotId,label:e.LotNo,bbd:e.BBD,lifetime:e.LifeTime}),Ws=pe.injectEndpoints({endpoints:e=>({getLots:e.query({query:t=>({url:"",method:"GET",params:{command:L.GET_LOTS,emelClass:"API3PL",json:JSON.stringify(t)}}),transformResponse:({Lots:t,Error:r})=>({Lots:t==null?void 0:t.map(Us),Error:r}),providesTags:["LOT"]})})}),Hs=e=>{const[t,r]=d.useState(!1),[l,x]=d.useState([]),[m,h]=d.useState(!0),[C]=Ws.useLazyGetLotsQuery(),i=V();d.useEffect(()=>{h(!e)},[e]);const c=d.useCallback(async b=>{if(b)try{r(!0);const{Lots:j=[],Error:y}=await C({GoodItemId:e.id}).unwrap();y&&i(Re({message:y})),x(j)}catch{}finally{r(!1)}},[e]);return[l,t,m,c]},$e=({isEditMode:e,orderId:t,onCancelEditMode:r,isLoading:l})=>{const[x,m]=d.useState([]),[h,C]=d.useState([]),{register:i,setValue:c,unregister:b,resetField:j,watch:y}=qe(),[u]=ne.useLazyGetOrderLinesQuery(),[S]=ls.useLazyGetMeasurementUnitsQuery(),{data:A}=Xe.useGetGoodsQuery(),T=!!ue(a=>a.modalState).openedIds.find(a=>a===M.EDIT_ORDER_MODAL_ID),Q=V(),E=d.useCallback(a=>{b("orderLines"),a.forEach(n=>{const{id:D}=n;c(`orderLines[${D}].bbd`,Ie(n.bbd)),c(`orderLines[${D}].prd`,Ie(n.prd)),c(`orderLines[${D}].count`,n.count),c(`orderLines[${D}].good`,n.good),c(`orderLines[${D}].goodArticle`,n.good.article),c(`orderLines[${D}].measurementUnit`,n.measurementUnit),c(`orderLines[${D}].lot`,n.lot)})},[T]),o=d.useCallback(async()=>{if(t)try{const{OrderLine:a,Error:n}=await u({OrderId:t}).unwrap();n&&Q(Re({message:n})),a&&(m(a),E(a))}catch{}},[T]);d.useEffect(()=>{T&&o()},[T]);const f=()=>m([...x,{id:Date.now(),status:"new"}]),B=a=>{m(n=>n.filter(({id:D})=>D!==a)),b(`orderLines[${a}]`)},p=(a,n)=>{m(D=>D.map(R=>R.id===a?{...R,...n}:R))},N=d.useCallback(a=>s.jsx(z,{isReplacing:!e,path:`orderLines[${a.row.id}].good.label`,rootClassName:g.lineCell,children:s.jsx(te,{items:(A==null?void 0:A.Goods)||[],registered:i(`orderLines[${a.row.id}].good`,{required:O.required}),required:!0,placeholder:"Выберите",size:"s",virtualScroll:!0,disabled:l,onChange:async n=>{if(c(`orderLines[${a.row.id}].goodArticle`,n==null?void 0:n.article),p(a.row.id,{goodLabel:n==null?void 0:n.label,goodArticle:n==null?void 0:n.article}),j(`orderLines[${a.row.id}].measurementUnit`),j(`orderLines[${a.row.id}].lot`),(n==null?void 0:n.id)!==void 0){const{data:D}=await S({GoodItemId:n==null?void 0:n.id});D!=null&&D.MU&&(c(`orderLines[${a.row.id}].measurementUnit`,D==null?void 0:D.MU[0]),p(a.row.id,{MU:D==null?void 0:D.MU[0].label}))}}})}),[A,e,l]),le=d.useCallback(a=>s.jsx(k,{registered:i(`orderLines[${a.row.id}].goodArticle`),readOnly:!0,required:e,className:g.lineCell,size:"s",type:"textarea",disabled:l}),[e,l]),q=d.useCallback(a=>{const n=y(`orderLines[${a.row.id}].good`),[D,R,he,de]=is(n);return s.jsx(z,{isReplacing:!e,path:`orderLines[${a.row.id}].measurementUnit.label`,rootClassName:g.lineCell,children:s.jsx(te,{registered:i(`orderLines[${a.row.id}].measurementUnit`,{required:O.required}),required:!0,placeholder:"Выберите",size:"s",onChange:Y=>p(a.row.id,{MU:Y==null?void 0:Y.label}),virtualScroll:!0,isLoading:R,items:D,disabled:he||l,onDropdownOpen:de})})},[e,l]),be=d.useCallback(a=>s.jsx(k,{registered:i(`orderLines[${a.row.id}].count`,{required:O.required,onChange:n=>p(a.row.id,{count:n.target.value})}),readOnly:!e,required:e,size:"s",className:g.lineCell,type:"textarea",disabled:l}),[e,l]),De=d.useCallback(a=>s.jsx(z,{isReplacing:!e,path:`orderLines[${a.row.id}].bbd`,rootClassName:g.lineCell,valueModifier:J,children:s.jsx(se,{registered:i(`orderLines[${a.row.id}].bbd`,{required:O.required}),required:e,size:"s",format:"dd/MM/yyyy",placeholder:"дд/мм/гггг",disabled:l,onChange:n=>p(a.row.id,{bbd:n==null?void 0:n.toString()})})}),[e,l]),xe=d.useCallback(a=>s.jsx(z,{isReplacing:!e,path:`orderLines[${a.row.id}].prd`,rootClassName:g.lineCell,valueModifier:J,children:s.jsx(se,{registered:i(`orderLines[${a.row.id}].prd`,{required:O.required}),required:!0,size:"s",format:"dd/MM/yyyy",placeholder:"дд/мм/гггг",disabled:l,onChange:n=>p(a.row.id,{prd:n==null?void 0:n.toString()})})}),[e,l]),me=d.useCallback(a=>{const n=y(`orderLines[${a.row.id}].good`),[D,R,he,de]=Hs(n);return s.jsx(z,{isReplacing:!e,path:`orderLines[${a.row.id}].lot.label`,rootClassName:g.lineCell,children:s.jsx(te,{registered:i(`orderLines[${a.row.id}].lot`,{required:O.required}),required:!0,placeholder:"Выберите",size:"s",onChange:Y=>p(a.row.id,{lotNo:Y==null?void 0:Y.label}),virtualScroll:!0,isLoading:R,items:D,disabled:he||l,onDropdownOpen:de})})},[e,l]),F=d.useCallback(a=>s.jsx("div",{className:g.lineCell,children:s.jsx(_,{size:"s",view:"clear",onClick:()=>{B(a.row.id),C(h.filter(({id:n})=>n!==a.row.id))},iconLeft:Te,onlyIcon:!0,disabled:!e||l})}),[B,e,l]),ie=[{title:"",accessor:"select",renderCell:d.useCallback(a=>s.jsx("div",{className:g.lineCell,children:s.jsx(ye,{size:"s",checked:!!h.find(n=>a.row.id===n.id),view:"primary",onChange:()=>oe(a.row),disabled:!e||l})}),[h,e,l]),maxWidth:40,renderHeaderCell:v},{title:"Наименование",accessor:"goodLabel",renderCell:N,width:"auto",renderHeaderCell:v},{title:"Артикул",accessor:"goodArticle",renderCell:le,maxWidth:120,renderHeaderCell:v},{title:"Кол-во",accessor:"count",renderCell:be,maxWidth:120,renderHeaderCell:v},{title:"ЕИ",accessor:"MU",renderCell:q,maxWidth:120,renderHeaderCell:v},{title:"Партия",accessor:"lotNo",renderCell:me,maxWidth:150,renderHeaderCell:v},{title:"BBD",accessor:"bbd",renderCell:De,maxWidth:120,renderHeaderCell:v},{title:"PRD",accessor:"prd",renderCell:xe,maxWidth:120,renderHeaderCell:v},{title:"",accessor:"actions",maxWidth:40,renderCell:F,renderHeaderCell:v}],oe=a=>{const n=h.find(({id:D})=>D===a.id);C(n?h.filter(({id:D})=>D!==a.id):[...h,a])},P=()=>{h.forEach(a=>{B(a.id)}),C([])},Ge=()=>{r==null||r(),o()},Me=()=>{h.length===x.length?C([]):C(x)};return s.jsxs(I,{direction:"column",className:g.tableWrapper,children:[e&&s.jsxs(I,{className:g.handles,children:[s.jsx(_,{onClick:f,size:"s",label:"Новая строка",view:"secondary",iconLeft:Fe,disabled:!e||l}),r&&s.jsx(_,{onClick:Ge,disabled:!e||l,label:"Отменить изменения",type:"button",size:"s",view:"secondary"}),s.jsx(_,{size:"s",label:"Удалить выбранные",view:"secondary",disabled:!e||!h.length||l,onClick:P})]}),s.jsx(Ye,{data:x,children:({sortedData:a,handleSort:n,sortColumn:D})=>s.jsx(Le,{className:g.orderLineTable,rows:a,headerZIndex:0,columns:ie.map(R=>({...R,renderHeaderCell:({tableRef:he,...de})=>R.accessor==="select"?s.jsx(v,{onClick:Me,className:g.checkboxHeader,controlLeft:s.jsx(ye,{size:"s",checked:!!h.length&&h.length===a.length,view:"primary",disabled:l})}):s.jsx(v,{isActive:R.accessor===D,icon:R.title?s.jsx(_e,{isActive:D===R.accessor}):void 0,onClick:()=>n(R.accessor||"good"),...de})}))})}),x.length===0&&s.jsx(K,{className:g.emptyTableText,align:"center",size:"s",children:"Нажмите “+ Новая строка” для добавления груза"})]})},Js=()=>{const[e,t]=d.useState({isActive:!1}),{showToast:r}=re(),l=V(),x=()=>l(ge()),m=Oe(),{handleSubmit:h,reset:C,setValue:i,clearErrors:c}=m;d.useEffect(()=>{const S=w(new Date);S&&i("creationDate",S)},[]);const[b]=X.usePostOrderMutation(),[j]=ne.usePostOrderLineMutation(),[y]=X.useRunOrderMutation(),u=async(S,A)=>{try{t({isActive:!0,isIntroduced:!!A});const $=[],{OrderId:T,Error:Q}=await b(Gs(S)).unwrap();if(Q&&$.push(Q),T){for(let E in S.orderLines){const o=S.orderLines[E],{Error:f}=await j(Pe(o,T)).unwrap();f&&$.push(f)}if(A){const{Error:E}=await y({OrderId:T,StatusCode:ze.INTRODUCED}).unwrap();E&&$.push(E)}}$.length?$.forEach(E=>r(E)):(C(),x())}catch{}finally{t({isActive:!1})}};return s.jsx(Se,{...m,children:s.jsxs("form",{onSubmit:h(S=>u(S,!0)),className:g.form,children:[s.jsxs(I,{direction:"column",className:g.innerFormWrapper,children:[s.jsx(ke,{isLoading:e.isActive,isEditMode:!0}),s.jsx($e,{isLoading:e.isActive,isEditMode:!0})]}),s.jsxs(I,{className:g.handles,children:[s.jsx(_,{onClick:h(S=>u(S)),label:"Сохранить",view:"clear",size:"s",loading:e.isActive&&!e.isIntroduced,disabled:e.isActive&&e.isIntroduced}),s.jsx(_,{type:"submit",label:"Завершить ввод",size:"s",loading:e.isActive&&e.isIntroduced,disabled:e.isActive&&!e.isIntroduced})]})]})})},Vs=()=>s.jsx(je,{modalId:M.ADD_ORDER_MODAL_ID,title:"Новый заказ (статус - Редактируется)",children:s.jsx(Js,{})}),Qs=({orderId:e})=>{var B;const[t,r]=d.useState({isActive:!1}),[l,x]=d.useState(!1),m=()=>x(!l),h=Oe(),{handleSubmit:C,setValue:i,clearErrors:c}=h,{data:b,refetch:j}=X.useGetOrderByIdQuery({OrderId:e}),[y]=X.usePutOrderMutation(),[u]=ne.useLazyGetOrderLinesQuery(),[S]=ne.usePutOrderLineMutation(),[A]=ne.usePostOrderLineMutation(),[$]=ne.useDeleteOrderLineMutation(),[T]=X.useRunOrderMutation(),{showToast:Q}=re(),E=d.useCallback(()=>{if(b!=null&&b.Order){const p=b.Order;i("orderNumber",p.no),i("client",p.client),i("shipmentAddress",p.shipmentAddress),i("warehouse",p.warehouse),i("driver",p.driver),i("amNumber",p.amNumber),i("sealNumber",p.sealNumber),i("warehouse",p.warehouse),i("loadEndDate",p.loadEndDate),i("loadStartDate",p.loadStartDate),i("shipmentDate",p.shipmentDate),i("creationDate",p.creationDate),i("departureDate",p.departureDate),i("warehouseCode",p.warehouse.code),i("shipmentAddressCode",p.shipmentAddress.code),i("clientCode",p.clientCode)}},[b]);d.useEffect(()=>{E()},[b]);const o=()=>{c(),E(),j(),m()},f=async(p,N)=>{var le;try{r({isActive:!0,isIntroduced:!!N});const q=[],{INTRODUCED:be,EDITED:De}=ze;if(((le=b==null?void 0:b.Order)==null?void 0:le.status)==="Введен"){const{Error:F}=await T({OrderId:e,StatusCode:De}).unwrap();F&&q.push(F)}const{result:xe,Error:me}=await y(Ms(p,e)).unwrap();if(me&&q.push(me),xe=="Ok"){const{OrderLine:F}=await u({OrderId:e},!0).unwrap();for(let U in p.orderLines){const ie=p.orderLines[U];if(F==null?void 0:F.find(P=>P.id===parseInt(U))){const{Error:P}=await S(Bs(ie,parseInt(U))).unwrap();P&&q.push(P)}else{const{Error:P}=await A(Pe(ie,e)).unwrap();P&&q.push(P)}}if(F==null||F.forEach(async U=>{var oe;if(!((oe=p.orderLines)==null?void 0:oe[U.id])){const{Error:P}=await $({OrderLineId:U.id}).unwrap();P&&q.push(P)}}),N){const{Error:U}=await T({OrderId:e,StatusCode:be}).unwrap();U&&q.push(U)}}q.length?q.forEach(F=>Q(F)):o()}catch{}finally{r({isActive:!1})}};return s.jsx(Se,{...h,children:s.jsxs("form",{onSubmit:C(p=>f(p,!0)),className:g.form,children:[s.jsxs(I,{direction:"column",className:g.innerFormWrapper,children:[s.jsx(ke,{isEditMode:l,isLoading:t.isActive}),s.jsx($e,{onCancelEditMode:o,orderId:e,isEditMode:l,isLoading:t.isActive})]}),s.jsxs(I,{className:g.handles,children:[((B=b==null?void 0:b.Order)==null?void 0:B.removal)&&!l&&s.jsx(_,{onClick:m,label:"Редактировать",type:"button",size:"s"}),!!l&&s.jsxs(s.Fragment,{children:[s.jsx(_,{label:"Сохранить",size:"s",view:"clear",onClick:C(p=>f(p)),loading:t.isActive&&!t.isIntroduced,disabled:t.isActive&&t.isIntroduced}),s.jsx(_,{label:"Завершить ввод",size:"s",type:"submit",loading:t.isActive&&t.isIntroduced,disabled:t.isActive&&!t.isIntroduced})]})]})]})})},Zs=({order:e})=>s.jsx(je,{modalId:M.EDIT_ORDER_MODAL_ID,title:`Заказ №${e==null?void 0:e.no} (Статус - ${e==null?void 0:e.status})`,children:e&&s.jsx(Qs,{orderId:e.orderId})}),Ks=()=>{const t=!!ue(c=>c.modalState).openedIds.find(c=>c===M.DELETE_ORDER_MODAL_ID),{order:r}=ue(c=>c.orderDataState),l=V(),x=()=>l(ge()),{showToast:m}=re(),[h,{isLoading:C}]=X.useDeleteOrderMutation(),i=async()=>{if(r)try{const{Error:c}=await h({OrderId:r.orderId}).unwrap();c?m(c):x()}catch{m(Ve.errorRequest)}};return s.jsx(os,{confirmBtnLabel:"Удалить",closeModal:x,onClick:i,title:"Удаление заказа",text:`Вы действительно хотите удалить заказ ${r==null?void 0:r.no}?`,isOpen:t,isLoading:C})},Xs=()=>{const[e,{isLoading:t}]=X.useUploadOrderMutation(),{showToast:r}=re(),l=async x=>{try{const m=x[0],h=await cs(m);if(typeof h=="string"){const{result:C,Error:i}=await e({FileName:m.name,FileBase64:h}).unwrap();C!=null&&r(C,"success"),i&&r(i)}}catch{}};return s.jsx(ds,{modalId:M.IMPORT_ORDERS,onUpload:l,title:"Загрузить заказы файлом",isLoading:t})},Ys=({order:e})=>s.jsxs(s.Fragment,{children:[s.jsx(Vs,{}),s.jsx(Zs,{order:e}),s.jsx(Ks,{}),s.jsx(es,{}),s.jsx(ks,{}),s.jsx(us,{title:"Добавить нового клиента",modalId:M.ADD_NEW_CLIENT,clientType:ms.client}),s.jsx(Xs,{})]}),et="_container_50a2e_1",st="_main_50a2e_6",tt="_noData_50a2e_10",rt="_loader_50a2e_16",at="_cellButton_50a2e_21",Ne={container:et,main:st,noData:tt,loader:rt,cellButton:at},pt=()=>{const[e,t]=d.useState(null),r=V(),l=m=>r(Ce(m)),x=m=>{l(M.EDIT_ORDER_MODAL_ID),t(m)};return s.jsx(xs,{children:s.jsx(I,{className:Ne.container,direction:"column",children:s.jsxs(I,{className:Ne.main,direction:"column",children:[s.jsx(Ts,{onEditOrder:x}),s.jsx(Ys,{order:e})]})})})};export{pt as default};
