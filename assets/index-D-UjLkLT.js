import{r as x,j as s,b as pe,a as w,e as Pe,f as ke,g as P,h as qe,c as Y,u as te,o as de,i as Ee,k as We,l as Ce}from"./index-CnjHjZ9w.js";import{T as v,L as y}from"./Layout-_-Xp0wVg.js";import{B as $e,C as Be,D as Ue,m as O,u as Ge,I as Se,c as ve,G as W,s as C,a as X,R as k,b as se,d as He,e as Ve,M as je,f as Me,U as Qe,t as Je,g as Ye,h as Ke}from"./toBase64-PEfcJN1Z.js";import{R as Ze,I as Xe,C as es,T as Ne,H as D,S as ye,D as G,g as ss,a as ge,b as ts,A as ns}from"./Alert-Cnu6Ys1Q.js";import{f as Q,r as be,a as $,B as as,u as fe,w as rs,T as os,b as L,m as z,D as ie,I as ce,c as ls,d as ne,e as is,g as De,F as Ie}from"./useToast-bJRhAPp4.js";import{B as T}from"./MixSpace-D6Pb7ywy.js";import{T as cs}from"./TextField-BsGPomXW.js";import{I as xe,L as ds}from"./LayoutContainer-bIW1f0r6.js";import{o as ms}from"./organizationApi-Sa8nE9hd.js";import"./createResponsesImage-DXUTwyiR.js";const us=({asnList:e,...n})=>{const{accessor:t,openedFilter:d}=n,m=x.useMemo(()=>e.map(i=>{let c;return t&&(t==="creationDate"||t==="shipmentDate"?c=Q(i[t]):c=i[t]),{name:c||"(Пусто)",value:t?i[t].toString():""}}),[e]);return s.jsx(Ze,{isOpen:d===t,checkboxes:m,...n})},hs=({status:e})=>{const n=x.useMemo(()=>{switch(!0){case e==="Присвоен номер":return"#D1D2DE";case e==="Заполняется":return"#F5222D";case e==="Все строки обработаны":return"#FADB14";case e==="Обработка завершена":return"#52C41A";case e==="Новый":return"#2fc2eb";default:return"#D1D2DE"}},[e]);return s.jsxs(s.Fragment,{children:[e!=="-"&&s.jsx($e,{style:{boxShadow:`inset 0 0 0 var(--badge-size) ${n}`,flexShrink:0},minified:!0,size:"s"}),s.jsx(v,{size:"s",lineHeight:"s",children:e})]})},Ae=e=>({asnId:e.AsnId,no:e.No,extNo:e.ExtNo,comment:e.Comment,incomingNo:e.IncomingNo,incomingState:(e==null?void 0:e.IncomingState)||"Новый",client:{label:e.Supplier.Name,id:e.Supplier.ClientId,code:e.Supplier.Code},clientId:e.Supplier.ClientId,clientLabel:e.Supplier.Name,clientCode:e.Supplier.Code,warehouse:{label:e.WarehouseFrom.Name,id:e.WarehouseFrom.WarehouseId,code:e.WarehouseFrom.Code,shippingWarehouse:0},organization:{label:e.VendorFrom.Name,id:e.VendorFrom.ClientId,code:e.VendorFrom.Code,shippingWarehouse:0},operator:e.Operator,creationDate:be(e.Date),shipmentDate:be(e.ExpectedIncomeDate),editable:e.Editable,removal:e.IncomingState==="Присвоен номер"||!e.IncomingNo}),J=pe.injectEndpoints({endpoints:e=>({getAsnById:e.query({query:()=>({url:"",method:"GET",params:{command:w.GET_ASN,json:JSON.stringify({DateFrom:$(new Date("01/01/1991")),DateTo:$(new Date)}),emelClass:"API3PL"}}),transformResponse:({Asn:n,Error:t},d,{AsnId:m})=>{const i=n==null?void 0:n.find(c=>(c==null?void 0:c.AsnId)==m);return{Asn:i?Ae(i):void 0,Error:t}},providesTags:["ASN"]}),getAsn:e.query({query:n=>({url:"",method:"GET",params:{command:w.GET_ASN,json:JSON.stringify(n),emelClass:"API3PL"}}),transformResponse:({Asn:n,Error:t})=>({Asn:n==null?void 0:n.map(Ae),Error:t}),providesTags:["ASN"]}),postAsn:e.mutation({query:n=>({url:"",method:"POST",params:{command:w.POST_ASN,json:JSON.stringify(n),emelClass:"API3PL"}}),invalidatesTags:["ASN"]}),putAsn:e.mutation({query:n=>({url:"",method:"POST",params:{command:w.PUT_ASN,json:JSON.stringify(n),emelClass:"API3PL"}}),invalidatesTags:["ASN"]}),deleteAsn:e.mutation({query:n=>({url:"",method:"POST",params:{command:w.DELETE_ASN,json:JSON.stringify(n),emelClass:"API3PL"}}),invalidatesTags:["ASN"]}),uploadAsn:e.mutation({query:n=>({url:"",method:"POST",params:{command:w.UPLOAD_ASN,emelClass:"API3PL"},body:{TockenId:Pe.getState().authUser.token,FileEncode:"1251",...n}}),invalidatesTags:["ORDER"]})})}),ps=()=>{const e=ke(),n=t=>e(qe({columns:t}));return s.jsx(Be,{onSetTableCols:n,cols:Object.values(P).filter(t=>t.title)})},xs="_toolbar_9uf6u_1",gs="_buttons_group_9uf6u_8",bs="_buttons_9uf6u_8",ee={toolbar:xs,buttons_group:gs,buttons:bs},As=({onResetFilters:e,startDate:n,endDate:t,search:d,setSearch:m,...i})=>{const c=Y(),S=l=>c(de(l)),u=te(l=>l.asnTableState),g=l=>{console.log(u)},A=[{label:"EXCEL",handleClick:g},{label:"PDF",handleClick:g}];return s.jsxs(y,{className:ee.toolbar,direction:"column",children:[s.jsxs(y,{className:ee.filter_group,children:[s.jsx(Ue,{startDate:n,endDate:t,...i}),s.jsx(y,{children:s.jsx(cs,{className:ee.search,placeholder:"Найти заказ по номеру",rightSide:Xe,value:d,type:"text",size:"s",onChange:m})})]}),s.jsxs(y,{className:ee.buttons_group,children:[s.jsx(y,{children:s.jsx(T,{className:"button",label:"Новый ASN",size:"s",view:"secondary",iconLeft:xe,onClick:()=>S(O.ADD_ASN_MODAL_ID)})}),s.jsxs(y,{className:ee.buttons,children:[s.jsx(T,{onClick:e,className:"button",label:"Очистить все фильтры",size:"s",view:"secondary"}),s.jsx(ps,{}),s.jsx(T,{className:"button",label:"Импорт из файла",size:"s",view:"secondary",onClick:()=>S(O.IMPORT_ASN)}),s.jsx(as,{buttonName:"Экспорт таблицы",btns:A})]})]})]})},Cs="_table_xedfn_1",Ss="_cell_xedfn_19",js="_cellButton_xedfn_24",Ns="_switchButton_xedfn_31",ys="_noData_xedfn_35",fs="_pagination_xedfn_42",F={table:Cs,cell:Ss,cellButton:js,switchButton:Ns,noData:ys,pagination:fs},Ds=({onEditAsn:e})=>{const n=Ge(),[t,d]=x.useState(null),m=Y(),{data:i,isLoading:c}=J.useGetAsnQuery({DateFrom:$(n.startDate)||"",DateTo:$(n.endDate)||""}),S=x.useMemo(()=>{var b;return((b=i==null?void 0:i.Asn)==null?void 0:b.filter(o=>o.no.toLowerCase().startsWith((t==null?void 0:t.toLowerCase())||"")))||[]},[t,i]),{columns:u}=te(b=>b.asnTableState),g=b=>{m(We({asn:b})),m(de(O.DELETE_ASN_MODAL_ID))},A=x.useMemo(()=>[{...P.no,minWidth:180,renderCell:({row:o})=>s.jsx(G,{style:{cursor:"pointer"},className:F.cell,onClick:()=>e(o),children:s.jsx(v,{size:"s",view:"brand",children:o.no?o.no:"-"})})},{...P.creationDate,minWidth:180,renderCell:({row:o})=>s.jsx(G,{className:F.cell,children:s.jsx(v,{size:"s",children:o.creationDate?Q(o.creationDate):"-"})})},{...P.shipmentDate,minWidth:180,renderCell:({row:o})=>s.jsx(G,{className:F.cell,children:s.jsx(v,{size:"s",children:o.shipmentDate?Q(o.shipmentDate):"-"})})},{...P.incomingState,minWidth:180,renderCell:({row:o})=>s.jsx(G,{className:F.cell,children:s.jsx(hs,{status:o.incomingState?o.incomingState:"-"})})},{...P.incomingNo,minWidth:180,renderCell:({row:o})=>s.jsx(G,{className:F.cell,children:s.jsx(v,{size:"s",children:o.incomingNo?o.incomingNo:"-"})})},{...P.clientCode,minWidth:180,renderCell:({row:o})=>s.jsx(G,{className:F.cell,children:s.jsx(v,{size:"s",children:o.clientCode?o.clientCode:"-"})})},{...P.clientLabel,minWidth:180,renderCell:({row:o})=>s.jsx(G,{className:F.cell,children:s.jsx(v,{size:"s",children:o.clientLabel?o.clientLabel:"-"})})},{title:"",accessor:"removal",maxWidth:40,renderCell:({row:o})=>s.jsx(G,{className:F.cellButton,children:s.jsx(T,{size:"s",view:"clear",iconRight:Se,onlyIcon:!0,onClick:()=>g(o),disabled:!o.removal})}),renderHeaderCell:D}].filter(({accessor:o})=>(u==null?void 0:u.some(f=>f.accessor===o))||P[o||""].isRequired),[u]),l=x.useCallback(b=>{m(Ee(b))},[]);return s.jsx(es,{onSetRows:l,data:S,isLoading:c,paginationClass:F.pagination,children:({paginatedData:b,sortColumn:o,handleSort:f,...q})=>s.jsxs(s.Fragment,{children:[s.jsx(As,{...n,setSearch:d,search:t,onResetFilters:q.resetFilters}),s.jsx(y,{direction:"column",children:s.jsx(Ne,{className:F.table,rows:b,stickyHeader:!0,headerZIndex:1,getRowKey:j=>j.asnId,columns:A.map(j=>({...j,renderHeaderCell:({tableRef:B,..._})=>s.jsx(D,{isActive:j.accessor===o,controlRight:j.title?[s.jsx(us,{accessor:j.accessor||Object.values(P)[0].accessor,asnList:S,...q})]:null,icon:j.title?s.jsx(ye,{isActive:j.accessor===o}):void 0,onClick:()=>f(j.accessor||"asnId"),..._})}))})})]})})},Is=e=>{const{GoodsItem:n,MU:t}=e;return{id:e.AsnLineId,good:{id:n.GoodItemId,article:n.Code,brutto:n.Brutto,height:n.Height,length:n.Length,label:n.Name,netto:n.Netto,width:n.Width},goodArticle:n.Code,goodLabel:n.Name,bbd:e.BBD,comment:e.Comment,count:e.Count,lot:e.Lot,measurementUnit:{id:t.MuId,label:t.Name,extId:t.ExtMuId,extLabel:t.ExtName},status:"",stockStatus:e.StockStatus,MU:t.Name}},M=pe.injectEndpoints({endpoints:e=>({getAsnLines:e.query({query:n=>({url:"",method:"POST",params:{command:w.GET_ASN_LINES,json:JSON.stringify(n),emelClass:"API3PL"}}),transformResponse:({AsnLine:n,Error:t})=>({AsnLine:n==null?void 0:n.map(Is),Error:t}),providesTags:["ASN_LINE"]}),postAsnLine:e.mutation({query:n=>({url:"",method:"POST",params:{command:w.POST_ASN_LINE,json:JSON.stringify(n),emelClass:"API3PL"}}),invalidatesTags:["ASN_LINE"]}),putAsnLine:e.mutation({query:n=>({url:"",method:"POST",params:{command:w.PUT_ASN_LINE,json:JSON.stringify(n),emelClass:"API3PL"}}),invalidatesTags:["ASN_LINE"]}),deleteAsnLine:e.mutation({query:({id:n})=>({url:"",method:"POST",params:{command:w.DELETE_ASN_LINE,json:JSON.stringify({AsnLineId:n}),emelClass:"API3PL"}}),invalidatesTags:["ASN_LINE"]})})}),Ls=e=>({Asn:{No:e.no,ExtNo:e.extNo,Comment:e.comment,WarehouseFromId:e.warehouse.id,WarehouseToId:e.warehouse.id,SupplierId:e.client.id,VendorFromId:e.organization.id,VendorToId:e.organization.id,Editable:!0,ExpectedIncomeDate:$(new Date(e.shipmentDate))||""}}),ws=(e,n)=>({Asn:{AsnId:n,No:e.no,ExtNo:e.extNo,Comment:e.comment,WarehouseFromId:e.warehouse.id,WarehouseToId:e.warehouse.id,SupplierId:e.client.id,VendorFromId:e.organization.id,VendorToId:e.organization.id,Editable:!0,ExpectedIncomeDate:$(new Date(e.shipmentDate))||""}}),Le=(e,n)=>({AsnLine:{AsnId:n,GoodsItemId:e.good.id,Count:parseInt(e.count),MuId:e.measurementUnit.id,StockStatus:"N",BBD:$(new Date(e.bbd))||"",Comment:e.comment,Lot:e.lot,ExtCount:0,RegLineRo:0,SsccCode:"",RegNoRo:""}}),Ts=(e,n,t)=>({AsnLine:{AsnLineId:t,AsnId:n,GoodsItemId:e.good.id,Count:parseInt(e.count),MuId:e.measurementUnit.id,StockStatus:"N",BBD:$(new Date(e.bbd))||"",Lot:e.lot,ExtCount:0,SsccCode:"",RegNoRo:"",RegLineRo:0,Comment:e.comment}}),_s=pe.injectEndpoints({endpoints:e=>({getSuppliers:e.query({query:()=>({url:"",params:{command:w.GET_SUPPLIERS,emelClass:"API3PL"}}),transformResponse:({ClientList:n,Error:t})=>({Suppliers:n==null?void 0:n.map(ve),Error:t}),providesTags:["Suppliers"]}),postSupplier:e.mutation({query:n=>({url:"",method:"POST",params:{command:w.POST_CLIENT,emelClass:"API3PL",json:JSON.stringify(n)}}),invalidatesTags:["Suppliers"]})})}),we=({isEditMode:e,isLoading:n})=>{const{register:t,setValue:d}=fe(),{data:m}=_s.useGetSuppliersQuery(),{data:i}=rs.useGetWarehousesQuery(),{data:c}=ms.useGetOrganizationQuery(),S=Y(),u=()=>S(de(O.ADD_NEW_SUPPLIER));return s.jsx(os,{children:({step:g,steps:A})=>s.jsxs(s.Fragment,{children:[s.jsxs(W,{cols:2,colGap:"s",className:g===A[0]?void 0:C.hidden,children:[s.jsx(X,{children:s.jsxs(W,{rowGap:"s",children:[s.jsx(L,{registered:t("no",{required:z.required,setValueAs:l=>l.trim()}),readOnly:!e,required:e,type:"text",label:"ASN Номер",placeholder:"Введите номер ASN",size:"s",disabled:n}),s.jsx(X,{children:s.jsxs(W,{cols:2,yAlign:"top",gap:"s",children:[s.jsx(k,{isReplacing:!e,label:"Поставщик",path:"client.label",children:s.jsx(se,{items:(m==null?void 0:m.Suppliers)||[],registered:t("client",{required:z.required}),required:e,label:"Поставщик",onChange:l=>d("clientCode",(l==null?void 0:l.code)||""),size:"s",disabled:n,placeholder:"Выберите"})}),s.jsxs(W,{cols:2,yAlign:"bottom",gap:"s",className:C.fieldWithBtn,children:[s.jsx(L,{registered:t("clientCode"),readOnly:!0,type:"text",label:"Код",size:"s",placeholder:"Поставщик"}),s.jsx(T,{disabled:!e||n,size:"s",view:"secondary",iconRight:xe,onlyIcon:!0,onClick:u})]})]})}),s.jsx(X,{children:s.jsxs(W,{cols:2,yAlign:"top",gap:"s",children:[s.jsx(k,{isReplacing:!e,label:"Организация",path:"organization.label",children:s.jsx(se,{items:(c==null?void 0:c.Organizations)||[],registered:t("organization",{required:z.required}),required:e,label:"Организация",onChange:l=>d("organizationCode",(l==null?void 0:l.code)||""),size:"s",disabled:n,placeholder:"Выберите"})}),s.jsx(L,{registered:t("organizationCode"),readOnly:!0,type:"text",label:"Код",size:"s",placeholder:"Организация-собственник"})]})}),s.jsxs(W,{cols:2,yAlign:"top",gap:"s",children:[s.jsx(k,{label:"Склад",isReplacing:!e,path:"warehouse.label",children:s.jsx(se,{items:(i==null?void 0:i.Warehouse)||[],registered:t("warehouse",{required:z.required}),required:e,label:"Склад",placeholder:"Выберите",onChange:l=>d("warehouseCode",(l==null?void 0:l.code)||""),size:"s",disabled:n})}),s.jsx(L,{registered:t("warehouseCode"),readOnly:!0,type:"text",label:"Код",size:"s",placeholder:"Склад"})]})]})}),s.jsx(X,{children:s.jsxs(W,{rowGap:"s",children:[s.jsx(L,{registered:t("operator",{required:z.required,setValueAs:l=>l.trim()}),readOnly:!e,required:e,type:"text",label:"Оператор",size:"s",disabled:n,placeholder:"Оператор"}),s.jsx(L,{registered:t("incomingNo",{setValueAs:l=>l.trim()}),disabled:!0,type:"text",label:"Номер прихода",size:"s",placeholder:"Номер прихода"}),s.jsx(L,{registered:t("extNo",{required:z.required,setValueAs:l=>l.trim()}),readOnly:!e,required:e,type:"text",label:"Внешний номер",placeholder:"Внешний номер",size:"s"}),s.jsx(L,{registered:t("comment",{setValueAs:l=>l.trim()}),readOnly:!e,type:"textarea",label:"Комментарий",size:"s",placeholder:"Комментарий"})]})})]}),s.jsx(W,{cols:2,colGap:"s",className:g===A[1]?void 0:C.hidden,children:s.jsx(X,{children:s.jsxs(W,{rowGap:"s",children:[s.jsx(k,{isReplacing:!e,label:"Создан",path:"creationDate",valueModifier:Q,children:s.jsx(ie,{registered:t("creationDate",{valueAsDate:!0}),readOnly:!0,required:e,rightSide:ce,size:"s",label:"Создан",format:"dd/MM/yyyy",placeholder:"дд/мм/гггг",disabled:!0})}),s.jsx(k,{label:"Ожидаемое время прибытия",isReplacing:!e,path:"shipmentDate",valueModifier:Q,children:s.jsx(ie,{registered:t("shipmentDate",{required:z.required,valueAsDate:!0}),readOnly:!e,required:e,rightSide:ce,size:"s",label:"Ожидаемое время прибытия",format:"dd/MM/yyyy",placeholder:"дд/мм/гггг"})}),s.jsx(k,{label:"Время фактического прихода",isReplacing:!e,path:"factDate",valueModifier:ls,children:s.jsx(ie,{registered:t("factDate",{valueAsDate:!0}),readOnly:!e,rightSide:ce,size:"s",label:"Время фактического прихода",format:"dd/MM/yyyy",placeholder:"дд/мм/гггг"})})]})})})]})})},zs=[{label:"N - нормальный",id:"N"},{label:"B - брак",id:"B"},{label:"Q - карантин",id:"Q"},{label:"H - близок к просрочке",id:"H"},{label:"E - просрочен",id:"E"},{label:"K - входной контроль",id:"K"}],Te=({isEditMode:e,asnId:n,isLoading:t,onCancelEditMode:d})=>{const[m,i]=x.useState([]),[c,S]=x.useState([]),g=!!te(a=>a.modalState).openedIds.find(a=>a===O.EDIT_ASN_MODAL_ID),{showToast:A}=ne(),{register:l,setValue:b,unregister:o,resetField:f,watch:q}=fe(),[j]=M.useLazyGetAsnLinesQuery(),[B]=He.useLazyGetMeasurementUnitsQuery(),{data:_}=ss.useGetGoodsQuery(),H=x.useCallback(a=>{o("orderLines"),a.forEach(r=>{const{id:h}=r,N=zs.find(le=>le.id===r.stockStatus);b(`asnLines[${h}].good`,r.good),b(`asnLines[${h}].goodArticle`,r.goodArticle),b(`asnLines[${h}].measurementUnit`,r.measurementUnit),b(`asnLines[${h}].count`,r.count),b(`asnLines[${h}].stockStatus`,N),b(`asnLines[${h}].lot`,r.lot),b(`asnLines[${h}].bbd`,is(r.bbd)),b(`asnLines[${h}].comment`,r.comment)})},[g]),ae=x.useCallback(async()=>{if(n)try{const{AsnLine:a,Error:r}=await j({AsnId:n}).unwrap();r&&A(r),a&&(i(a),H(a))}catch{}},[g]);x.useEffect(()=>{g&&ae()},[g]);const re=()=>i([...m,{id:Date.now()}]),V=a=>{i(r=>r.filter(({id:h})=>h!==a)),o(`asnLines[${a}]`)},p=(a,r)=>{i(h=>h.map(N=>N.id===a?{...N,...r}:N))},E=x.useCallback(a=>s.jsx(k,{isReplacing:!e,path:`asnLines[${a.row.id}].good.label`,rootClassName:C.lineCell,children:s.jsx(se,{items:(_==null?void 0:_.Goods)||[],registered:l(`asnLines[${a.row.id}].good`,{required:z.required}),required:!0,size:"s",virtualScroll:!0,placeholder:"Выберите",disabled:!e||t,onChange:async r=>{if(b(`asnLines[${a.row.id}].goodArticle`,r==null?void 0:r.article),p(a.row.id,{goodLabel:r==null?void 0:r.label,goodArticle:r==null?void 0:r.article}),f(`asnLines[${a.row.id}].measurementUnit`),(r==null?void 0:r.id)!==void 0){const{data:h}=await B({GoodItemId:r==null?void 0:r.id});h!=null&&h.MU&&(b(`asnLines[${a.row.id}].measurementUnit`,h==null?void 0:h.MU[0]),p(a.row.id,{MU:h==null?void 0:h.MU[0].label}))}}})}),[_,e,t]),me=x.useCallback(a=>s.jsx(L,{registered:l(`asnLines[${a.row.id}].goodArticle`),readOnly:!0,size:"s",type:"textarea",className:C.lineCell,disabled:t}),[e,t]),oe=x.useCallback(a=>{const r=q(`asnLines[${a.row.id}].good`),[h,N,le,ue]=Ve(r);return s.jsx(k,{isReplacing:!e,path:`asnLines[${a.row.id}].measurementUnit.label`,rootClassName:C.lineCell,children:s.jsx(se,{registered:l(`asnLines[${a.row.id}].measurementUnit`,{required:z.required}),required:!0,placeholder:"Выберите",size:"s",onChange:he=>p(a.row.id,{MU:he==null?void 0:he.label}),virtualScroll:!0,isLoading:N,items:h,disabled:!e||le||t,onDropdownOpen:ue})})},[e,t]),R=x.useCallback(a=>s.jsx(L,{registered:l(`asnLines[${a.row.id}].count`,{required:z.required,onChange:r=>p(a.row.id,{count:r.target.value})}),readOnly:!e,required:e,size:"s",className:C.lineCell,type:"textarea",disabled:t}),[e,t]),U=x.useCallback(a=>s.jsx(k,{isReplacing:!e,path:`asnLines[${a.row.id}].bbd`,rootClassName:C.lineCell,valueModifier:Q,children:s.jsx(ie,{registered:l(`asnLines[${a.row.id}].bbd`,{required:z.required}),readOnly:!e,required:e,rightSide:ce,size:"s",format:"dd/MM/yyyy",placeholder:"дд/мм/гггг",onChange:r=>p(a.row.id,{bbd:r==null?void 0:r.toString()}),disabled:t})}),[e,t]),K=x.useCallback(a=>s.jsx(k,{isReplacing:!e,path:`asnLines[${a.row.id}].lot`,rootClassName:C.lineCell,children:s.jsx(L,{registered:l(`asnLines[${a.row.id}].lot`,{setValueAs:r=>r.trim(),onChange:r=>p(a.row.id,{lot:r.target.value})}),size:"s",type:"textarea",disabled:t})}),[e,t]),Z=x.useCallback(a=>s.jsx(L,{registered:l(`asnLines[${a.row.id}].comment`,{setValueAs:r=>r.trim(),onChange:r=>p(a.row.id,{comment:r.target.value})}),readOnly:!e,className:C.lineCell,size:"s",type:"textarea",disabled:t}),[e,t]),I=x.useCallback(a=>s.jsx("div",{className:C.lineCell,children:s.jsx(T,{disabled:!e||t,size:"s",view:"clear",onClick:()=>V(a.row.id),iconLeft:Se,onlyIcon:!0})}),[V,e,t]),_e=[{title:"",accessor:"select",renderCell:x.useCallback(a=>s.jsx("div",{className:C.lineCell,children:s.jsx(ge,{disabled:!e||t,size:"s",checked:!!c.find(r=>a.row.id===r.id),view:"primary",onChange:()=>ze(a.row)})}),[c,e,t]),maxWidth:40,renderHeaderCell:D},{title:"Наименование",accessor:"goodLabel",renderCell:E,width:"auto",renderHeaderCell:D},{title:"Артикул",accessor:"goodArticle",renderCell:me,maxWidth:120,renderHeaderCell:D},{title:"Кол-во",accessor:"count",renderCell:R,maxWidth:110,renderHeaderCell:D},{title:"ЕИ",accessor:"MU",renderCell:oe,maxWidth:110,renderHeaderCell:D},{title:"BBD",accessor:"bbd",renderCell:U,maxWidth:110,renderHeaderCell:D},{title:"Партия",accessor:"lot",renderCell:K,maxWidth:110,renderHeaderCell:D},{title:"Коммент.",accessor:"comment",renderCell:Z,maxWidth:110,renderHeaderCell:D},{title:"",accessor:"actions",maxWidth:40,renderCell:I,renderHeaderCell:D}],ze=a=>{const r=c.find(({id:h})=>h===a.id);S(r?c.filter(({id:h})=>h!==a.id):[...c,a])},Oe=()=>{c.forEach(a=>{V(a.id)}),S([])},Re=()=>{d==null||d(),ae()},Fe=()=>{c.length===m.length?S([]):S(m)};return s.jsxs(y,{direction:"column",className:C.innerFormWrapper,children:[e&&s.jsxs(y,{className:C.handles,children:[s.jsx(T,{onClick:re,size:"s",label:"Новая строка",view:"secondary",iconLeft:xe,disabled:!e||t}),d&&s.jsx(T,{onClick:Re,size:"s",label:"Отменить изменения",view:"secondary",disabled:!e||t}),s.jsx(T,{size:"s",label:"Удалить выбранные",view:"secondary",disabled:!e||!c.length||t,onClick:Oe})]}),s.jsx(ts,{data:m,children:({sortedData:a,handleSort:r,sortColumn:h})=>s.jsx(Ne,{className:C.orderLineTable,rows:a,headerZIndex:0,columns:_e.map(N=>({...N,renderHeaderCell:({tableRef:le,...ue})=>N.accessor==="select"?s.jsx(D,{onClick:Fe,className:C.checkboxHeader,controlLeft:s.jsx(ge,{size:"s",checked:!!c.length&&c.length===a.length,view:"primary",disabled:t})}):s.jsx(D,{isActive:N.accessor===h,icon:N.title?s.jsx(ye,{isActive:h===N.accessor}):void 0,onClick:()=>r(N.accessor||"good"),...ue})}))})}),m.length===0&&s.jsx(v,{className:C.emptyTableText,align:"center",size:"s",children:"Нажмите “+ Новая строка” для добавления груза"})]})},Os=e=>{const[n,t]=x.useState(!1),{showToast:d}=ne(),m=De(),{handleSubmit:i,reset:c,setValue:S}=m,u=Y(),g=()=>u(Ce());x.useEffect(()=>{const o=$(new Date);o&&S("creationDate",o)},[]);const[A]=J.usePostAsnMutation(),[l]=M.usePostAsnLineMutation(),b=async o=>{try{t(!0);const f=[],{AsnId:q,Error:j}=await A(Ls(o)).unwrap();if(j&&f.push(j),q)for(let B in o.asnLines){const _=o.asnLines[B],{Error:H}=await l(Le(_,q)).unwrap();H&&f.push(H)}f.length?f.forEach(B=>d(B)):(c(),g())}catch{}finally{t(!1)}};return s.jsx(Ie,{...m,children:s.jsxs("form",{onSubmit:i(b),className:C.form,children:[s.jsxs(y,{direction:"column",className:C.innerFormWrapper,children:[s.jsx(we,{isLoading:n,isEditMode:!0}),s.jsx(Te,{isLoading:n,isEditMode:!0})]}),s.jsx(y,{className:C.handles,children:s.jsx(T,{label:"Сохранить",type:"submit",size:"s",loading:n})})]})})},Rs=()=>s.jsx(je,{modalId:O.ADD_ASN_MODAL_ID,title:"Новый ASN",children:s.jsx(Os,{})}),Fs=({asnId:e})=>{var re,V;const[n,t]=x.useState(!1),[d,m]=x.useState(!1),i=()=>m(!d),c=De(),{handleSubmit:S,setValue:u,clearErrors:g}=c,{data:A,refetch:l}=J.useGetAsnByIdQuery({AsnId:e}),[b]=J.usePutAsnMutation(),[o]=M.useLazyGetAsnLinesQuery(),[f]=M.usePutAsnLineMutation(),[q]=M.usePostAsnLineMutation(),[j]=M.useDeleteAsnLineMutation(),{showToast:B}=ne(),_=x.useCallback(()=>{if(A!=null&&A.Asn){const p=A.Asn;u("no",p.no),u("extNo",p.extNo),u("operator",p.operator),u("comment",p.comment),u("client",p.client),u("clientCode",p.clientCode),u("incomingNo",p.incomingNo),u("organization",p.organization),u("warehouse",p.warehouse),u("creationDate",p.creationDate),u("warehouseCode",p.warehouse.code),u("supplierCode",p.clientCode),u("organizationCode",p.organization.code),u("shipmentDate",p.shipmentDate)}},[A]);x.useEffect(()=>{_()},[A]);const H=()=>{g(),_(),l(),i()},ae=async p=>{try{t(!0);const E=[],{result:me,Error:oe}=await b(ws(p,e)).unwrap();if(oe&&E.push(oe),me=="Ok"){const{AsnLine:R}=await o({AsnId:e}).unwrap();for(let U in p.asnLines){const K=p.asnLines[U];if(R==null?void 0:R.find(I=>I.id===parseInt(U))){const{Error:I}=await f(Ts(K,e,parseInt(U))).unwrap();I&&E.push(I)}else{const{Error:I}=await q(Le(K,e)).unwrap();I&&E.push(I)}}R==null||R.forEach(async U=>{var Z;if(!((Z=p.asnLines)==null?void 0:Z[U.id])){const{Error:I}=await j({id:U.id}).unwrap();I&&E.push(I)}})}E.length?E.forEach(R=>B(R)):H()}catch{}finally{t(!1)}};return s.jsx(Ie,{...c,children:s.jsxs("form",{onSubmit:S(ae),className:C.form,children:[s.jsxs(y,{direction:"column",className:C.innerFormWrapper,children:[s.jsx(we,{isEditMode:d,isLoading:n}),s.jsx(Te,{onCancelEditMode:H,asnId:e,isEditMode:d,isLoading:n})]}),s.jsxs(y,{className:C.handles,children:[((re=A==null?void 0:A.Asn)==null?void 0:re.removal)&&!d&&s.jsx(T,{onClick:i,disabled:!!d,label:"Редактировать",type:"button",size:"s"}),!!d&&s.jsx(T,{disabled:!d||!((V=A==null?void 0:A.Asn)!=null&&V.editable),label:"Сохранить",type:"submit",size:"s"})]})]})})},Ps=({asn:e})=>s.jsx(je,{modalId:O.EDIT_ASN_MODAL_ID,title:`ASN №${e==null?void 0:e.no} (Статус прихода - ${e==null?void 0:e.incomingState})`,children:e&&s.jsx(Fs,{asnId:e.asnId})}),ks=()=>{const n=!!te(g=>g.modalState).openedIds.find(g=>g===O.DELETE_ASN_MODAL_ID),{asn:t}=te(g=>g.asnDataState),d=Y(),m=()=>d(Ce()),{showToast:i}=ne(),[c,{isLoading:S}]=J.useDeleteAsnMutation(),u=async()=>{if(t)try{const{Error:g}=await c({AsnId:t.asnId}).unwrap();g?i(g):m()}catch{}};return s.jsx(Me,{confirmBtnLabel:"Удалить",closeModal:m,onClick:u,title:"Удаление заказа",text:`Вы действительно хотите удалить ASN ${t==null?void 0:t.no}?`,isOpen:n,isLoading:S})},qs=()=>{const[e,{isLoading:n}]=J.useUploadAsnMutation(),{showToast:t}=ne(),d=async m=>{try{const i=m[0],c=await Je(i);if(typeof c=="string"){const{result:S,Error:u}=await e({FileName:i.name,FileBase64:c}).unwrap();S!=null&&t(S,"success"),u&&t(u)}}catch{}};return s.jsx(Qe,{modalId:O.IMPORT_ASN,onUpload:d,title:"Загрузить ASN файлом",isLoading:n})},Es=({asn:e})=>s.jsxs(s.Fragment,{children:[s.jsx(Rs,{}),s.jsx(Ps,{asn:e}),s.jsx(ks,{}),s.jsx(Ye,{title:"Добавить нового Поставщика",modalId:O.ADD_NEW_SUPPLIER,clientType:Ke.supplier}),s.jsx(ns,{}),s.jsx(qs,{})]}),Ws="_main_ursag_1",$s={main:Ws},Zs=()=>{const[e,n]=x.useState(null),t=Y(),d=i=>t(de(i)),m=i=>{d(O.EDIT_ASN_MODAL_ID),n(i)};return s.jsx(ds,{children:s.jsxs(y,{className:$s.main,direction:"column",children:[s.jsx(Ds,{onEditAsn:m}),s.jsx(Es,{asn:e})]})})};export{Zs as default};
